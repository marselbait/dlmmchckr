<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meteora Multi-Token DLMM Investment Dashboard</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            padding: 20px;
        }
        .card {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            width: 90%;
            max-width: 800px;
        }
        .tokenName {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        .input-group {
            margin-bottom: 10px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #333;
        }
        input, select {
            width: 100%;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            width: 100%;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        #resetButton {
            background-color: #f44336;
        }
        #resetButton:hover {
            background-color: #d32f2f;
        }
        #errorMessage {
            color: red;
            margin-top: 10px;
            font-size: 14px;
        }
        #timeElapsed {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
            margin-bottom: 20px;
        }
        .investment-list {
            margin-top: 20px;
        }
        .investment-item {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .blink {
            animation: blink 0.5s;
        }
    </style>
</head>
<body>
    <div class="card" id="dashboard">
        <h1>Meteora Multi-Token DLMM Investment Dashboard</h1>
        <div id="timeElapsed">Time Elapsed: 00:00:00</div>
        <div class="input-group">
            <label for="token1">Token 1:</label>
            <input type="text" id="token1" placeholder="Enter token symbol (e.g., FWOG)">
        </div>
        <div class="input-group">
            <label for="token2">Token 2:</label>
            <input type="text" id="token2" placeholder="Enter token symbol (e.g., SOL)">
        </div>
        <div class="input-group">
            <label for="amount1">Amount of Token 1:</label>
            <input type="number" id="amount1" placeholder="Enter amount" step="0.000000000001">
        </div>
        <div class="input-group">
            <label for="amount2">Amount of Token 2:</label>
            <input type="number" id="amount2" placeholder="Enter amount" step="0.000000000001">
        </div>
        <button onclick="addInvestment()">Add Investment</button>
        <button id="resetButton" onclick="resetDashboard()">Reset All</button>
        <div id="errorMessage"></div>
        <div class="investment-list" id="investmentList"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <script>
        let investments = [];
        let updateInterval;
        let startTime;
        let elapsedInterval;

        function loadFromLocalStorage() {
            console.log("Loading from local storage...");
            try {
                const savedData = JSON.parse(localStorage.getItem('meteoraMultiTokenData'));
                if (savedData && savedData.investments) {
                    console.log("Saved data found:", savedData);
                    investments = savedData.investments;
                    renderInvestments();
                    startUpdates();
                } else {
                    console.log("No saved data found");
                }
            } catch (error) {
                console.error("Error loading from local storage:", error);
                showError("Error loading saved data. Please reset the dashboard.");
            }
        }

        function saveToLocalStorage() {
            console.log("Saving to local storage...");
            const dataToSave = {
                investments
            };
            localStorage.setItem('meteoraMultiTokenData', JSON.stringify(dataToSave));
        }

        function addInvestment() {
            const token1 = document.getElementById('token1').value.toUpperCase();
            const token2 = document.getElementById('token2').value.toUpperCase();
            const amount1 = parseFloat(document.getElementById('amount1').value);
            const amount2 = parseFloat(document.getElementById('amount2').value);

            if (!token1 || !token2 || isNaN(amount1) || isNaN(amount2)) {
                showError("Please fill in all fields with valid values.");
                return;
            }

            investments.push({
                token1,
                token2,
                amount1,
                amount2,
                id: Date.now() // Unique identifier for each investment
            });

            saveToLocalStorage();
            renderInvestments();
            startUpdates();

            // Clear input fields
            document.getElementById('token1').value = '';
            document.getElementById('token2').value = '';
            document.getElementById('amount1').value = '';
            document.getElementById('amount2').value = '';
        }

        function renderInvestments() {
            const listElement = document.getElementById('investmentList');
            listElement.innerHTML = '';

            investments.forEach(inv => {
                const item = document.createElement('div');
                item.className = 'investment-item';
                item.innerHTML = `
                    <h3>${inv.token1}/${inv.token2} Pool</h3>
                    <p>Investment: ${inv.amount1} ${inv.token1} and ${inv.amount2} ${inv.token2}</p>
                    <p>${inv.token1} Price: <span id="price_${inv.id}_${inv.token1}">Loading...</span></p>
                    <p>${inv.token2} Price: <span id="price_${inv.id}_${inv.token2}">Loading...</span></p>
                    <p>Total Liquidity: <span id="liquidity_${inv.id}">Loading...</span></p>
                    <p>24h Volume: <span id="volume_${inv.id}">Loading...</span></p>
                    <p>Your Position Value: <span id="position_${inv.id}">Loading...</span></p>
                    <p>Estimated Fees Earned: <span id="fees_${inv.id}">Loading...</span></p>
                    <button onclick="removeInvestment(${inv.id})">Remove</button>
                `;
                listElement.appendChild(item);
            });
        }

        function removeInvestment(id) {
            investments = investments.filter(inv => inv.id !== id);
            saveToLocalStorage();
            renderInvestments();
        }

        function startUpdates() {
            console.log("Starting updates...");
            clearInterval(updateInterval);
            clearInterval(elapsedInterval);
            startTime = Date.now();
            updateElapsedTime();
            elapsedInterval = setInterval(updateElapsedTime, 1000);

            fetchAllPoolData();
            updateInterval = setInterval(fetchAllPoolData, 30000); // Update every 30 seconds
        }

        function updateElapsedTime() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const hours = Math.floor(elapsed / 3600);
            const minutes = Math.floor((elapsed % 3600) / 60);
            const seconds = elapsed % 60;
            const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timeElapsed').textContent = `Time Elapsed: ${timeString}`;
        }

        async function fetchAllPoolData() {
            console.log("Fetching all pool data...");
            for (const inv of investments) {
                await fetchPoolData(inv);
            }
        }

        async function fetchPoolData(investment) {
            console.log(`Fetching pool data for ${investment.token1}/${investment.token2}...`);
            try {
                // Note: Replace this URL with the actual Meteora API endpoint when available
                const response = await axios.get(`https://api.meteora.ag/pools/${investment.token1}_${investment.token2}`);
                console.log('API Response:', response.data);

                // Process the data and update the dashboard
                updateInvestmentDisplay(investment, response.data);
            } catch (error) {
                console.error(`Error fetching pool data for ${investment.token1}/${investment.token2}:`, error);
                showError(`Error fetching pool data: ${error.message}`);
            }
        }

        function updateInvestmentDisplay(investment, data) {
            // Update token prices
            document.getElementById(`price_${investment.id}_${investment.token1}`).textContent = `$${data.token1Price.toFixed(12)}`;
            document.getElementById(`price_${investment.id}_${investment.token2}`).textContent = `$${data.token2Price.toFixed(12)}`;

            // Update pool stats
            document.getElementById(`liquidity_${investment.id}`).textContent = `$${data.totalLiquidity.toFixed(2)}`;
            document.getElementById(`volume_${investment.id}`).textContent = `$${data.volume24h.toFixed(2)}`;

            // Calculate and update position value
            const positionValue = (investment.amount1 * data.token1Price) + (investment.amount2 * data.token2Price);
            document.getElementById(`position_${investment.id}`).textContent = `$${positionValue.toFixed(2)}`;

            // Estimate fees (this is a simplified calculation and may not be accurate)
            const estimatedFees = (positionValue / data.totalLiquidity) * (data.volume24h * 0.003);
            document.getElementById(`fees_${investment.id}`).textContent = `$${estimatedFees.toFixed(2)}`;

            // Add blinking effect to updated values
            const elements = [
                `price_${investment.id}_${investment.token1}`,
                `price_${investment.id}_${investment.token2}`,
                `liquidity_${investment.id}`,
                `volume_${investment.id}`,
                `position_${investment.id}`,
                `fees_${investment.id}`
            ];
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.remove('blink');
                    void element.offsetWidth; // Trigger reflow
                    element.classList.add('blink');
                }
            });
        }

        function showError(message) {
            console.error("Error:", message);
            document.getElementById('errorMessage').textContent = message;
        }

        function resetDashboard() {
            console.log("Resetting dashboard...");
            localStorage.removeItem('meteoraMultiTokenData');
            investments = [];
            document.getElementById('investmentList').innerHTML = '';
            document.getElementById('token1').value = '';
            document.getElementById('token2').value = '';
            document.getElementById('amount1').value = '';
            document.getElementById('amount2').value = '';
            document.getElementById('timeElapsed').textContent = 'Time Elapsed: 00:00:00';
            clearInterval(updateInterval);
            clearInterval(elapsedInterval);
            document.getElementById('errorMessage').textContent = '';
        }

        // Load saved data on page load
        window.onload = loadFromLocalStorage;
    </script>
</body>
</html>
